# DB Schema Enricher

A command-line tool to enrich your database schema with metadata (primarily column comments) and easily manage those comments.  It's designed to help you document your database schema directly within the database itself, making it easier to understand and maintain.  It supports multiple database dialects, including PostgreSQL, MySQL, and SQL Server, with specific support for Google Cloud SQL.

## Key Features

*   **Add Comments:**  Generates SQL statements to add descriptive comments to your database columns.  These comments can be generated automatically (using the tool's logic) or customized.
*   **Get Comments:**  Retrieves existing column comments from your database and outputs them to the console or a file.
*   **Delete Comments:**  Removes comments added by this tool (specifically, comments within `<gemini>` tags), allowing you to clean up or revert changes.
*   **Apply Comments:**  Executes SQL statements from a file to apply comments to your database.  This is useful for applying the SQL generated by the `add-comments` or `delete-comments` command.
*   **Dry Run Mode:**  Preview the changes without actually modifying your database.  This is enabled by default.
*   **Multiple Database Dialects:** Supports PostgreSQL, MySQL, SQL Server, and their respective Google Cloud SQL variants.
*   **Update Existing Comments:** Choose to either overwrite existing comments or append to them.

## Installation

### From Source (Recommended)

1.  **Prerequisites:**
    *   Go 1.21 or later installed.
    *   `make` utility.

2.  **Clone the repository:**

    ```bash
    git clone https://github.com/GoogleCloudPlatform/db-context-enrichment.git
    cd db_schema_enricher
    ```

3.  **Build the binary:**

    ```bash
    make build
    ```
    This will create the `db_schema_enricher` executable in the current directory.

## Google Cloud Authentication

**Before using `db_schema_enricher` with Cloud SQL, you must authenticate with Google Cloud.**

Run the following command and follow the instructions to log in with your Google Cloud account:

```bash
gcloud auth application-default login
```

This command obtains credentials and stores them locally, allowing `db_schema_enricher` (and other tools using Application Default Credentials) to access your Cloud SQL instances.

## Usage

The general command structure is:

```bash
./db_schema_enricher <command> [flags]
```

### Global Flags

These flags apply to all commands:

| Flag                             | Description                                                                                                         | Default       |
| --------------------------------- | ------------------------------------------------------------------------------------------------------------------- | ------------- |
| `--dry-run`                       | Preview changes without modifying the database.  **Enabled by default.**                                           | `true`        |
| `--dialect string`                | Database dialect.  (See supported dialects below)                                                                 |               |
| `--host string`                   | Database host (for non-Cloud SQL connections).                                                                   |               |
| `--port int`                      | Database port (for non-Cloud SQL connections).                                                                   |               |
| `--username string`               | Database username.                                                                  |               |
| `--password string`               | Database password.    |               |
| `--database string`               | Database name.                                             |               |
| `--cloudsql-instance-connection-name string` | Cloud SQL instance connection name (required for Cloud SQL).   |               |
| `--cloudsql-use-private-ip`      | Use the private IP address for the Cloud SQL connection.                                                          | `false`       |
| `--update_existing string`          |How to handle existing comments: `overwrite` or `append`.                |      `overwrite`         |

**Supported Dialects:**

*   `postgres`
*   `mysql`
*   `sqlserver`
*   `cloudsqlpostgres`
*   `cloudsqlmysql`
*   `cloudsqlsqlserver`

### Commands

#### `add-comments`

Generates SQL statements to add comments to database columns.  By default, it outputs these statements to a file (e.g., `your_database_comments.sql`).  You can then review the generated SQL and apply it using the `apply-comments` command.

**Command-Specific Flags:**

| Flag           | Description                                                     | Default                         |
| -------------- | --------------------------------------------------------------- | -------------------------------- |
| `--out_file -o` | Path to the output SQL file.                                    | `<database_name>_comments.sql` |

**Example (Cloud SQL PostgreSQL - Dry Run):**

```bash
./db_schema_enricher add-comments \
  --dialect=cloudsqlpostgres \
  --username='DB_USER' \
  --password='YOUR_PASSWORD' \
  --database=db_financial \
  --cloudsql-instance-connection-name=your-project:region:your-postgres-instance \
  --out_file=./financial_db_comments.sql \
  --dry-run
```



Review the generated SQL file `financial_db_comments.sql`

Then, apply the changes:
```bash
./db_schema_enricher apply-comments \
  --dialect=cloudsqlpostgres \
  --username='DB_USER' \
  --password='YOUR_PASSWORD' \
  --database=db_financial \
  --cloudsql-instance-connection-name=your-project:region:your-postgres-instance \
  --in_file=./financial_db_comments.sql
```

#### `get-comments`

Retrieves existing column comments from the database.

**Command-Specific Flags:**

| Flag           | Description                                                    | Default                      |
| -------------- | -------------------------------------------------------------- | ----------------------------- |
| `--out_file -o` | Path to the output file to save the comments. | `<database_name>_comments.txt` |

**Example (Cloud SQL Postgres):**

```bash
db_schema_enricher get-comments \
  --dialect=cloudsqlpostgres \
  --username=db_user \
  --password='YOUR_PASSWORD' \
  --database=inventory_db \
  --cloudsql-instance-connection-name=your-project:region:your-postgres-instance \
  --out_file=./inventory_comments.txt
```

#### `delete-comments`

Generates SQL statements to remove comments added by this tool (specifically, comments within `<gemini>` tags).  This allows you to selectively remove the comments added by the enricher without affecting other comments.  The generated SQL is written to a file, and you should review it before applying it with `apply-comments`.

**Command-Specific Flags:**

| Flag           | Description                                                     | Default                         |
| -------------- | --------------------------------------------------------------- | -------------------------------- |
| `--out_file -o` | Path to the output SQL file.                                    | `<database_name>_comments.sql` |

**Example (SQL Server - Dry Run):**
```bash
db_schema_enricher delete-comments \
  --dialect=cloudsqlsqlserver \
  --username=sqlserver_user \
  --password='YOUR_PASSWORD' \
  --database=sales_db \
  --cloudsql-instance-connection-name=your-project:region:your-sqlserver-instance \
  --out_file=./delete_sales_comments.sql \
  --dry-run # recommended for delete comment
```

#### `apply-comments`

Executes SQL statements from a file to apply comments (or other SQL) to your database.  This is typically used to apply the SQL generated by `add-comments` or `delete-comments`.

**Command-Specific Flags:**

| Flag           | Description                                               | Default                         |
| -------------- | --------------------------------------------------------- | -------------------------------- |
| `--in_file -i` | Path to the input SQL file.                               | `<database_name>_comments.sql` |

**Example (Applying Comments):**

```bash
# After running add-comments/delete-comments and reviewing the output file:
db_schema_enricher apply-comments \
  --dialect=cloudsqlpostgres \
  --username=db_user \
  --password='YOUR_PASSWORD' \
  --database=financial_db \
  --cloudsql-instance-connection-name=your-project:region:your-postgres-instance \
  --in_file=./financial_db_comments.sql
```
